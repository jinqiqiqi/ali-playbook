#!/bin/bash
IP=`who -u am i 2>/dev/null| awk '{print $NF}'|sed -e 's/[()]//g'`;
HOST_IP=`/sbin/ifconfig | awk '{print $2}' | grep '192.168.' | awk -F: '{print $2}'`;
tmp=`/usr/sbin/lsof -ni -P 2>&1 | awk '$9 ~ /\->/ && $9 !~ /\->.*47\.100\.214\.33:22/ && $1 !~ /(yum|sdata|copylog|nrpe|check_mys|smtp)/ && $9 !~ /\-.*58.222.19.61.*/ && $9 !~ /\-.*61.155.217.*/ && $9 !~ /\->.*58\.211\.82\.68:22/ && $9 !~ /61.155.217.*(80|443)\-/ && $9 !~ /127\.0\.0\.1\-/ && $9 !~ /\-.*127\.0\.0\.1/ && $9 !~ /:22\->.*218\.4\.226\.238/  && $9 !~ /:22\->.*222\.92\.214\.186/ && $9 !~ /:22\->.*198\.54\.96\.66/ && $9 !~ /\-.*:(53|21|25|443|80|37)/ && $9 !~ /\->.*218\.4\.226\.238/ && $9 !~ /47\.96\.33\.35/ && $9 !~ /192\.168\.0.*:(11211|11212|11213|11214|11215|11216|11218|11219|11222|11223|11224|11226|11228|11229|11230|19312|21|22|25|3000|3002|3306|3305|3307|3308|3309|3310|3311|3312|3313|3314|3315|3316|443|514|53|6081|80|8080|9312|9393|5666|9200|5601|3005|11231|7986|5467|6379|110|37|9000|3302|3006|10051|27017|5672|9200|11221|10221|9316|11343)\-/ && $9 !~ /\-.*192\.168\.0.*:(11211|11212|11213|11214|11215|11216|11218|11219|11222|11223|11224|11226|11228|11229|11230|19312|21|22|25|3000|3002|3306|3305|3307|3308|3309|3310|3311|3312|3313|3314|3315|3316|443|514|53|6081|80|8080|9312|9393|5666|9200|5601|3005|11231|7986|5467|6379|110|37|9000|3302|3006|10051|27017|5672|9200|11221|10221|9316|11343)/  {print $1,$2,$3,$9,$10}'`;
[ -n "$tmp" ] && curl -s -X POST --data-urlencode "payload={\"text\": \"$tmp\", \"username\":\"${HOST_IP}($HOSTNAME::$IP)\"}" "https://hooks.slack.com/services/{{ slack_bashme_toke }}"  2>&1 > /dev/null && curl -s -X POST --data-urlencode "payload={\"text\": \"$tmp\", \"username\":\"${HOST_IP}($HOSTNAME::$IP)\"}" "http://218.4.226.238:8065/hooks/{{ mattermost_bashme_toke }}"  2>&1 > /dev/null ;

